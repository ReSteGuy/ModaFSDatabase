Sorry for the large source code blob